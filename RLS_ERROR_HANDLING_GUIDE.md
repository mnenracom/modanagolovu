# üîê –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫ RLS

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ RLS

#### `src/lib/rlsErrorHandler.ts`
- `isRLSError(error)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ RLS –æ—à–∏–±–∫–æ–π
- `handleRLSError(error)` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø
- `getErrorMessage(error)` - –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

#### `src/hooks/useRoleCheck.ts`
- `useRoleCheck()` - —Ö—É–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `hasRole(requiredRole)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–æ–ª—å
- `hasAnyRole(roles)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–¥–Ω—É –∏–∑ —Ä–æ–ª–µ–π
- `isAdmin()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `canManageContent()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞
- `canManageOrders()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏

#### `src/hooks/useRLSErrorHandler.tsx`
- `useRLSErrorHandler()` - —Ö—É–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ RLS –æ—à–∏–±–æ–∫ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- `handleError(error, customMessage)` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç toast
- `withErrorHandling(fn, customMessage)` - –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è async —Ñ—É–Ω–∫—Ü–∏–π

#### `src/components/auth/AccessDenied.tsx`
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –¥–æ—Å—Ç—É–ø–∞
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ RLS –æ—à–∏–±–æ–∫:
- ‚úÖ `productsService.ts`
- ‚úÖ `categoriesService.ts`
- ‚úÖ `bannersService.ts`
- ‚úÖ `ordersService.ts`

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

–û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:
- ‚úÖ `Products.tsx` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, —Å–æ–∑–¥–∞–Ω–∏–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, —É–¥–∞–ª–µ–Ω–∏–∏

## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏–º–µ—Ä 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—É–∫–∞ useRoleCheck

```tsx
import { useRoleCheck } from '@/hooks/useRoleCheck';

const MyComponent = () => {
  const { hasRole, hasAnyRole, isAdmin, canManageContent } = useRoleCheck();

  if (!hasRole('admin')) {
    return <div>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>;
  }

  if (canManageContent()) {
    // –ú–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
  }

  return <div>–ö–æ–Ω—Ç–µ–Ω—Ç</div>;
};
```

### –ü—Ä–∏–º–µ—Ä 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ

```tsx
import { useRLSErrorHandler } from '@/hooks/useRLSErrorHandler';
import { productsService } from '@/services/productsService';

const ProductsPage = () => {
  const { handleError, withErrorHandling } = useRLSErrorHandler();

  const loadProducts = async () => {
    try {
      const data = await productsService.getAll();
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    } catch (error) {
      await handleError(error, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã');
    }
  };

  // –ò–ª–∏ —Å –æ–±–µ—Ä—Ç–∫–æ–π:
  const saveProduct = async (productData: any) => {
    await withErrorHandling(async () => {
      await productsService.create(productData);
      // –£—Å–ø–µ—Ö
    }, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä');
  };
};
```

### –ü—Ä–∏–º–µ—Ä 3: –ü—Ä—è–º–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ try-catch

```tsx
try {
  await productsService.create(productData);
  toast({ title: '–£—Å–ø–µ—à–Ω–æ', description: '–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω' });
} catch (error: any) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º RLS –æ—à–∏–±–∫—É
  if (error.isRLSError) {
    toast({
      title: '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞',
      description: error.message,
      variant: 'destructive',
      duration: 5000,
      action: error.requiresRelogin ? {
        label: '–í–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ',
        onClick: () => navigate('/admin/login'),
      } : undefined,
    });
  } else {
    toast({
      title: '–û—à–∏–±–∫–∞',
      description: error.message,
      variant: 'destructive',
    });
  }
}
```

### –ü—Ä–∏–º–µ—Ä 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ AccessDenied

```tsx
import AccessDenied from '@/components/auth/AccessDenied';

const ProtectedPage = () => {
  const { user, loading } = useAuth();
  const { hasRole } = useRoleCheck();

  if (loading) return <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

  if (!hasRole('admin')) {
    return (
      <AccessDenied 
        message="–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ"
        requiresRelogin={false}
      />
    );
  }

  return <div>–ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã</div>;
};
```

## üîç –¢–∏–ø—ã –æ—à–∏–±–æ–∫ RLS

### 1. –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (permission denied)
- **–ü—Ä–∏—á–∏–Ω–∞**: –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏
- **–†–µ—à–µ–Ω–∏–µ**: –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
- **–¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∞**: –ù–µ—Ç

### 2. –ò—Å—Ç–µ–∫—à–∞—è —Å–µ—Å—Å–∏—è (expired token)
- **–ü—Ä–∏—á–∏–Ω–∞**: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫
- **–†–µ—à–µ–Ω–∏–µ**: –í–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
- **–¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∞**: –î–∞

### 3. –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å (invalid role)
- **–ü—Ä–∏—á–∏–Ω–∞**: –†–æ–ª—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –∏–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- **–†–µ—à–µ–Ω–∏–µ**: –í–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤
- **–¢—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∞**: –î–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã** —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ RLS –æ—à–∏–±–æ–∫
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏ (RLS –∏–ª–∏ –æ–±—ã—á–Ω–∞—è)
3. **–ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è** –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
5. **Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –ø—Ä–∏ RLS –æ—à–∏–±–∫–∞—Ö

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö:
- `Categories.tsx`
- `Banners.tsx`
- `Orders.tsx`
- –ò –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –≤—ã—à–µ –∫–∞–∫ —à–∞–±–ª–æ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.




