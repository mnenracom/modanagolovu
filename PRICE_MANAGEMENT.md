# Система управления ценами для маркетплейсов

## Описание

Система позволяет управлять ценами товаров на маркетплейсах WildBerries и OZON, контролировать маржинальность и автоматически корректировать цены на основе анализа конкурентов.

## Установка

### 1. Создание таблицы в базе данных

Выполните SQL скрипт `create_price_rules_table.sql` в Supabase Dashboard → SQL Editor:

```sql
-- Скрипт создаст таблицу price_rules для хранения ценовых правил
```

### 2. Установка зависимостей

Библиотека `xlsx` уже установлена для парсинга Excel файлов.

## Использование

### 1. Синхронизация товаров с маркетплейсов

**ВАЖНО:** Сначала необходимо синхронизировать товары с маркетплейсов, чтобы получить актуальные данные.

1. Перейдите в **Админ-панель → Управление ценами**
2. Откройте вкладку **"Загрузка из Excel"**
3. Нажмите кнопку **"Синхронизировать товары"**
4. Система автоматически:
   - Получит список всех товаров с WildBerries и OZON через API
   - Сохранит данные о товарах (название, цена, артикул, штрихкод, категория и т.д.)
   - Создаст базовые ценовые правила для каждого товара (с пустыми значениями себестоимости и ценовых лимитов)

**Примечание:** Убедитесь, что API ключи настроены в разделе "Настройки МП" перед синхронизацией.

### 2. Загрузка ценовых правил из Excel

После синхронизации товаров загрузите Excel файл с себестоимостью и ценовыми лимитами:

1. Скачайте шаблон Excel файла (кнопка "Скачать шаблон")
2. Заполните шаблон данными:
   - **sku** (обязательно) - Артикул товара (должен совпадать с артикулом на маркетплейсе)
   - **cost_price** (обязательно) - Себестоимость
   - **min_price** (обязательно) - Минимальная цена
   - **max_price** (обязательно) - Максимальная цена
   - **target_margin** (опционально) - Целевая маржа в процентах (по умолчанию 20%)

3. Загрузите заполненный файл через форму

**Важно:** 
- Остальные данные (название, текущая цена, категория и т.д.) **автоматически берутся из синхронизированных товаров**
- Если товар с указанным SKU не найден, система предупредит вас - сначала синхронизируйте товары
- Если в файле указаны `marketplace` и `account`, система обновит правило для конкретного аккаунта
- Если не указаны, система найдет товар во всех аккаунтах и обновит первое найденное правило

### 3. Просмотр ценовых правил

На вкладке **"Ценовые правила"** отображается таблица всех загруженных правил с информацией:
- SKU товара
- Текущая цена на маркетплейсе
- Себестоимость
- Минимальная и максимальная цена
- Рассчитанная маржа
- Статус маржинальности
- Рекомендуемая цена

### 3. Фильтрация

Используйте фильтры для поиска нужных товаров:
- **Маркетплейс** - фильтр по типу маркетплейса (WB/OZON)
- **Аккаунт** - фильтр по аккаунту
- **Статус** - фильтр по статусу маржинальности
- **Поиск по SKU** - поиск по артикулу или названию товара

### 4. Проверка маржинальности

1. Нажмите кнопку **"Проверить маржинальность"**
2. Система проверит все отфильтрованные товары:
   - Получит текущие цены с маркетплейсов
   - Рассчитает маржу и прибыль
   - Определит статус маржинальности
   - Рассчитает рекомендуемые цены

**Статусы маржинальности:**
- **OK** - цена в допустимом диапазоне, маржа достаточна
- **Низкая маржа** - маржа ниже целевой
- **Ниже минимума** - цена ниже минимальной
- **Выше максимума** - цена выше максимальной
- **Нет данных** - не удалось получить текущую цену

### 5. Автоматическое исправление цен

Для товаров, требующих исправления:
1. В таблице отображается кнопка **"Исправить"**
2. Нажмите кнопку для автоматической корректировки цены
3. Система:
   - Анализирует цены конкурентов (если доступно)
   - Устанавливает рекомендуемую цену
   - Обновляет цену на маркетплейсе через API
   - Обновляет статус в базе данных

**Примечание:** Функция анализа цен конкурентов и автоматического обновления цен через API требует дополнительной настройки в зависимости от доступности соответствующих API маркетплейсов.

## Структура базы данных

### Таблица `price_rules`

Основные поля:
- `sku` - Артикул товара
- `marketplace_type` - Тип маркетплейса ('wildberries' или 'ozon')
- `account_name` - Название аккаунта
- `min_price` - Минимальная цена
- `max_price` - Максимальная цена
- `cost_price` - Себестоимость
- `target_margin_percent` - Целевая маржа в процентах
- `current_price` - Текущая цена на маркетплейсе
- `margin_status` - Статус маржинальности
- `calculated_margin` - Рассчитанная маржа
- `recommended_price` - Рекомендуемая цена
- `price_change_needed` - Требуется ли изменение цены

## API интеграция

### Текущий статус

- ✅ Загрузка ценовых правил из Excel
- ✅ Хранение ценовых правил в БД
- ✅ Проверка маржинальности
- ✅ Расчет рекомендуемых цен
- ⚠️ Получение текущих цен с маркетплейсов (частично - через marketplace_products)
- ⚠️ Получение цен конкурентов (требует настройки)
- ⚠️ Автоматическое обновление цен через API (требует настройки)

### Для полной функциональности необходимо:

1. **Получение текущих цен:**
   - Интегрировать API маркетплейсов для получения актуальных цен товаров
   - Использовать методы `getProductBySku()` в `WildBerriesApiService` и `OzonApiService`

2. **Получение цен конкурентов:**
   - Использовать API маркетплейсов для получения цен конкурентов (если доступно)
   - Или использовать сторонние сервисы аналитики
   - Или парсить страницы товаров (менее надежно)

3. **Обновление цен:**
   - Интегрировать методы обновления цен в `WildBerriesApiService` и `OzonApiService`
   - Использовать соответствующие endpoints API маркетплейсов

## Примеры использования

### Синхронизация товаров

```typescript
import { MarketplaceProductsSyncService } from '@/services/marketplaceProductsSyncService';

// Синхронизировать все аккаунты
await MarketplaceProductsSyncService.syncAllAccounts();

// Синхронизировать конкретный аккаунт
const setting = await marketplaceService.getAllSettings()[0];
await MarketplaceProductsSyncService.syncAccount(setting);
```

### Загрузка данных из Excel

```typescript
// Формат Excel файла (только себестоимость и ценовые лимиты):
sku, cost_price, min_price, max_price, target_margin
ART001, 500, 1000, 2000, 20
ART002, 600, 1500, 2500, 25

// Остальные данные (название, цена, категория) берутся из синхронизированных товаров
```

### Программная проверка маржинальности

```typescript
import { PriceMarginService } from '@/services/priceMarginService';
import { priceRulesService } from '@/services/priceRulesService';

// Проверить все правила
await PriceMarginService.checkAllMargins();

// Проверить конкретное правило
const rule = await priceRulesService.getBySku('ART001', 'wildberries', 'Основной');
if (rule) {
  await PriceMarginService.checkMargin(rule);
}
```

### Исправление цены

```typescript
const rule = await priceRulesService.getBySku('ART001', 'wildberries', 'Основной');
if (rule && rule.priceChangeNeeded && rule.recommendedPrice) {
  await PriceMarginService.fixPrice(rule);
}
```

## Поддержка

При возникновении проблем:
1. Проверьте, что таблица `price_rules` создана в базе данных
2. Убедитесь, что настройки маркетплейсов настроены
3. Проверьте формат Excel файла (используйте шаблон)
4. Проверьте логи в консоли браузера (F12)

