# Настройка системы доставки

## Обзор изменений

Система заказов теперь разделена на два потока:

1. **Оптовые заказы** - используют форму заявки (`/checkout`)
2. **Розничные заказы** - проходят через выбор доставки (`/delivery`) и оплату (`/payment`)

## Настройка API Почты России

### 1. Получение API ключа и токена

1. Зарегистрируйтесь на [Почта России API](https://otpravka.pochta.ru/)
2. Получите **Authorization Key** (ключ авторизации):
   - Перейдите в раздел "Настройки" → "API"
   - Сгенерируйте ключ авторизации
   - Сохраните ключ
3. Получите **Access Token** (токен доступа):
   - Токен будет отправлен на вашу электронную почту после регистрации
   - Или получите его через API: https://otpravka.pochta.ru/specification#/authorization-token
4. Сохраните оба значения для дальнейшей настройки

### 2. Настройка в админ-панели

1. Перейдите в админ-панель → **Доставка** → **Службы доставки**
2. Найдите или создайте службу доставки с кодом `russian_post`
3. Заполните поля в разделе **API настройки**:
   - **API ключ** (поле "API Key") → введите **Authorization Key** из Почты России
   - **Секретный ключ** (поле "Secret Key") → введите **Access Token** из Почты России
   
   **Важно:**
   - Authorization Key → это **API ключ** (обязательное поле)
   - Access Token → это **Секретный ключ** (опционально, если не указан, используется API Key)
   
4. Убедитесь, что служба активна (включен переключатель "Активна")
5. Сохраните настройки

**Соответствие полей:**
```
Почта России API          →  Админ-панель
─────────────────────────────────────────
Authorization Key         →  API ключ (обязательно)
Access Token             →  Секретный ключ (опционально)
```

### 3. Настройка Edge Function

Edge Function `russian-post-api` уже создана и **полностью интегрирована** с реальным API Почты России в `supabase/functions/russian-post-api/index.ts`.

**Реализованные методы:**
- ✅ Поиск точек выдачи (`search_post_offices`) - использует `/1.0/office`
- ✅ Расчет стоимости доставки (`calculate_delivery`) - использует `/1.0/tariff`
- ✅ Получение информации о точке выдачи (`get_post_office`) - использует `/1.0/office/{index}`

**Особенности:**
- Функция автоматически обрабатывает ошибки API
- При ошибках API возвращаются тестовые данные (для разработки)
- Все запросы используют правильные заголовки авторизации
- Поддерживается фильтрация отделений по городу и региону

### 4. Деплой Edge Function

```bash
# Установите Supabase CLI, если еще не установлен
npm install -g supabase

# Войдите в Supabase
supabase login

# Свяжите проект
supabase link --project-ref YOUR_PROJECT_REF

# Деплой функции
supabase functions deploy russian-post-api
```

## Маршруты

- `/checkout` - Оформление оптового заказа (форма заявки)
- `/delivery` - Выбор доставки для розничных заказов
- `/payment` - Оплата розничного заказа

## Логика работы

### Оптовые заказы

1. Пользователь добавляет товары в корзину
2. Если сумма >= минимального оптового заказа → тип заказа = `wholesale`
3. При нажатии "Оформить заказ" → переход на `/checkout`
4. Заполнение формы заявки
5. Отправка заявки (работа с клиентом лично)

### Розничные заказы

1. Пользователь добавляет товары в корзину
2. Если сумма < минимального оптового заказа → тип заказа = `retail`
3. При нажатии "Оформить заказ" → переход на `/delivery`
4. Выбор города и поиск точек выдачи
5. Выбор точки выдачи и расчет стоимости доставки
6. Переход на `/payment`
7. Заполнение контактных данных и выбор способа оплаты
8. Оплата через ЮKassa
9. Перенаправление на страницу успеха

## Данные доставки

Данные о выбранной доставке сохраняются в `sessionStorage` под ключом `deliveryData`:

```typescript
{
  office: PostOffice,      // Выбранная точка выдачи
  calculation: DeliveryCalculation, // Расчет стоимости
  address: AddressData     // Адрес доставки
}
```

Эти данные используются на странице оплаты и при создании заказа.

## Интеграция карты

В текущей версии карта не интегрирована. Для добавления карты можно использовать:

- **Яндекс.Карты** - [React компонент](https://yandex.ru/dev/maps/jsapi/doc/2.1/quick-start/index.html)
- **Google Maps** - [React компонент](https://developers.google.com/maps/documentation/javascript/react-map)
- **Leaflet** - [React компонент](https://react-leaflet.js.org/)

Пример интеграции с Яндекс.Картами:

```bash
npm install @pbe/react-yandex-maps
```

```tsx
import { YMaps, Map, Placemark } from '@pbe/react-yandex-maps';

<YMaps>
  <Map defaultState={{ center: [55.75, 37.57], zoom: 10 }}>
    {postOffices.map(office => (
      <Placemark
        key={office.id}
        geometry={[office.latitude, office.longitude]}
        properties={{ balloonContent: office.name }}
      />
    ))}
  </Map>
</YMaps>
```

## Дальнейшие улучшения

1. ✅ ~~Реализовать реальную интеграцию с API Почты России~~ - **ГОТОВО**
2. Добавить карту с отображением точек выдачи (Яндекс.Карты, Google Maps)
3. Добавить другие службы доставки (СДЭК, Boxberry и т.д.)
4. Добавить возможность выбора нескольких точек выдачи
5. Кэширование результатов поиска точек выдачи
6. Сохранение адресов доставки для авторизованных пользователей
7. Добавить расчет стоимости для разных типов отправлений (EMS, первым классом и т.д.)

## Тестирование

После настройки API ключа:

1. Перейдите на страницу корзины
2. Добавьте товары (розничный заказ)
3. Нажмите "Оформить заказ"
4. На странице выбора доставки:
   - Введите город (например, "Москва")
   - Нажмите "Найти точки выдачи"
   - Выберите точку выдачи
   - Проверьте расчет стоимости доставки
5. Перейдите к оплате и завершите заказ

**Примечание:** Если API ключ не настроен или неверен, система будет использовать тестовые данные для проверки работоспособности интерфейса.

