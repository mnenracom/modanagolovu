# Настройка интеграции с маркетплейсами

## Обзор

Система позволяет интегрироваться с WildBerries и OZON для автоматической синхронизации данных о продажах, заказах и товарах. Вся аналитика отображается в едином дашборде в админ-панели.

## Установка

### 1. Создание таблиц в Supabase

Выполните SQL-скрипт `create_marketplace_tables.sql` в Supabase Dashboard → SQL Editor.

Это создаст следующие таблицы:
- `marketplace_settings` - настройки подключений к маркетплейсам
- `marketplace_sales` - статистика продаж по дням
- `marketplace_products` - товары с маркетплейсов
- `marketplace_orders` - заказы с маркетплейсов

### 2. Получение API ключей

#### WildBerries:
1. Зайдите в личный кабинет продавца WildBerries
2. Перейдите в раздел "Настройки" → "Доступ к API"
3. Создайте новый токен доступа для **Statistics API** (статистика и финансы)
4. Скопируйте токен (JWT токен, начинается с `eyJ...`)
5. Вставьте токен в поле "API ключ" (без слова "Bearer", система добавит его автоматически)

#### OZON:
1. Зайдите в личный кабинет продавца OZON
2. Перейдите в раздел "Настройки" → "API"
3. Создайте новый API ключ
4. Скопируйте API ключ и Client ID

### 3. Настройка в админ-панели

1. Зайдите в админ-панель
2. Перейдите в раздел "Маркетплейсы"
3. Выберите вкладку "WildBerries" или "OZON"
4. Заполните форму:
   - **Название аккаунта** - любое удобное название (например, "WB Основной", "OZON 1")
   - **API ключ** - ваш API ключ
   - **Seller ID** (только для WB) - опционально
   - **Client ID** (только для OZON) - обязательно для OZON
   - **Интервал синхронизации** - как часто синхронизировать данные (по умолчанию 60 минут)
5. Нажмите "Сохранить"
6. Нажмите "Тест" для проверки подключения
7. Нажмите "Синхронизировать" для первой загрузки данных

### 4. Просмотр аналитики

1. Перейдите в раздел "Дашборд МП"
2. Выберите фильтры:
   - Маркетплейс (Все / WildBerries / OZON)
   - Аккаунт (Все / конкретный аккаунт)
   - Период (Сегодня / 7 дней / 30 дней / 90 дней)
3. Просмотрите статистику:
   - Общая выручка и чистая выручка
   - Количество заказов и средний чек
   - Количество проданных товаров
   - Комиссия маркетплейсов
   - Детальная статистика по дням

## Автоматическая синхронизация

Для настройки автоматической синхронизации можно использовать:

### Вариант 1: Supabase Edge Functions (рекомендуется)

Создайте Edge Function, которая будет вызываться по расписанию через Supabase Cron Jobs.

### Вариант 2: Внешний cron job

Настройте cron job на вашем сервере, который будет вызывать функцию `syncAllMarketplaces()` из `marketplaceSyncService.ts`.

Пример:
```typescript
import { syncAllMarketplaces } from '@/services/marketplaceSyncService';

// Вызывать каждые 60 минут
setInterval(async () => {
  await syncAllMarketplaces();
}, 60 * 60 * 1000);
```

## Структура данных

### Marketplace Settings
- Хранит API ключи и настройки подключений
- Поддерживает несколько аккаунтов одного маркетплейса
- Отслеживает статус последней синхронизации

### Marketplace Sales
- Статистика продаж по дням
- Агрегированные данные: выручка, заказы, комиссия
- Метрики: просмотры, конверсия, рейтинги

### Marketplace Orders
- Детальная информация о каждом заказе
- Данные клиента, товары, суммы
- Статусы и отслеживание доставки

### Marketplace Products
- Информация о товарах на маркетплейсах
- Цены, остатки, статистика продаж
- Связь с товарами в вашей базе (опционально)

## API Endpoints

### WildBerries
- Базовый URL: `https://statistics-api.wildberries.ru`
- Аутентификация: через заголовок `Authorization` с API ключом (JWT токен)
- **Важно:** Токен должен быть создан для **Statistics API** (статистика и финансы)
- Основные endpoints:
  - `/api/v1/supplier/orders` - заказы
  - `/api/v5/supplier/reportDetailByPeriod` - отчет о продажах (работающий endpoint)
  
**Примечание:** Если получаете ошибку 404 "path not found", проверьте:
1. Токен создан для Statistics API (не для Marketplace API)
2. Токен имеет права доступа к нужным endpoints
3. В личном кабинете WB включен доступ к Statistics API

### OZON
- Базовый URL: `https://api-seller.ozon.ru`
- Аутентификация: через заголовки `Client-Id` и `Api-Key`
- Основные endpoints:
  - `/v3/posting/fbs/list` - заказы
  - `/v1/analytics/data` - аналитика
  - `/v2/product/list` - товары

## Безопасность

- API ключи хранятся в зашифрованном виде в базе данных
- Доступ к настройкам маркетплейсов только для администраторов
- Все запросы к API логируются для отладки

## Поддержка

При возникновении проблем:
1. Проверьте правильность API ключей
2. Убедитесь, что таблицы созданы в Supabase
3. Проверьте логи в консоли браузера (F12)
4. Проверьте статус последней синхронизации в настройках

