# Миграция для поддержки розничных и оптовых продаж

## Описание

Добавлена поддержка dual-цен (розничных и оптовых) в магазине. Теперь магазин может работать как в розницу, так и оптом.

## Что было сделано

### 1. Обновление таблицы `products`

Добавлены новые поля:
- `retail_price` (DECIMAL) - розничная цена
- `wholesale_price` (DECIMAL) - оптовая цена (уже существовало, обновлено)
- `wholesale_threshold` (INTEGER) - порог для опта (минимальное количество, по умолчанию 10)
- `min_retail_order` (DECIMAL) - минимальная сумма розничного заказа (по умолчанию 1000.00)
- `min_wholesale_order` (DECIMAL) - минимальная сумма оптового заказа (по умолчанию 5000.00)
- `economy_percent` (DECIMAL) - процент экономии при оптовой покупке (автоматически рассчитывается)

### 2. Обновление таблицы `orders`

Добавлены новые поля:
- `order_type` (VARCHAR) - тип заказа: 'retail' или 'wholesale'
- `original_total` (DECIMAL) - оригинальная сумма до скидок
- `final_total` (DECIMAL) - итоговая сумма после всех скидок
- `economy_amount` (DECIMAL) - сумма экономии

### 3. Обновление существующих данных

- Все существующие товары получили `retail_price = price`
- `wholesale_price` установлен (если был) или рассчитан как `retail_price * 0.8`
- `economy_percent` автоматически рассчитан для всех товаров
- Существующие заказы классифицированы как retail/wholesale на основе суммы (>= 5000 = wholesale)

### 4. Обновление TypeScript типов

Обновлены интерфейсы:
- `ProductSupabase` - добавлены новые поля для dual-цен
- `Product` - добавлены новые поля для dual-цен
- `OrderSupabase` - добавлены поля для типов заказов
- `Order` - добавлены поля для типов заказов

Обновлены функции трансформации:
- `transformProductFromSupabase` - преобразует новые поля
- `transformProductToSupabase` - сохраняет новые поля
- `transformOrderFromSupabase` - преобразует новые поля заказов
- `transformOrderToSupabase` - сохраняет новые поля заказов

## Инструкция по применению

1. **Выполните SQL миграцию:**
   ```sql
   -- Откройте файл migrate_dual_pricing.sql в Supabase Dashboard → SQL Editor
   -- Выполните весь скрипт
   ```

2. **Проверьте результаты:**
   - Убедитесь, что все товары имеют `retail_price` и `wholesale_price`
   - Проверьте, что `economy_percent` рассчитан корректно
   - Убедитесь, что существующие заказы имеют `order_type`

3. **Обновите код приложения:**
   - TypeScript типы уже обновлены
   - Функции трансформации обновлены
   - При необходимости обновите UI для отображения розничных/оптовых цен

## Использование в коде

### Получение цены товара

```typescript
// Розничная цена
const retailPrice = product.retailPrice ?? product.price ?? 0;

// Оптовая цена
const wholesalePrice = product.wholesalePrice ?? 0;

// Определение типа цены на основе количества
const isWholesale = quantity >= (product.wholesaleThreshold ?? 10);
const currentPrice = isWholesale ? wholesalePrice : retailPrice;
```

### Определение типа заказа

```typescript
// Автоматическое определение на основе суммы
const orderType = order.total >= 5000 ? 'wholesale' : 'retail';

// Или используйте поле из заказа
const orderType = order.orderType ?? 'retail';
```

### Расчет экономии

```typescript
const economyAmount = order.economyAmount ?? 0;
const economyPercent = product.economyPercent ?? 0;
```

## Важные замечания

1. **Обратная совместимость:** Поле `price` сохранено для обратной совместимости, но рекомендуется использовать `retailPrice` и `wholesalePrice`.

2. **Автоматический расчет:** `economy_percent` автоматически рассчитывается при сохранении товара, если не указан вручную.

3. **Минимальные суммы:** По умолчанию установлены минимальные суммы заказов (1000 для розницы, 5000 для опта). Их можно изменить для каждого товара.

4. **Порог опта:** По умолчанию оптовая цена применяется при количестве >= 10. Это можно настроить для каждого товара через `wholesale_threshold`.

## Следующие шаги

1. Обновите UI для отображения розничных и оптовых цен
2. Добавьте переключатель розница/опт в корзину
3. Обновите форму создания/редактирования товара для настройки dual-цен
4. Добавьте фильтрацию заказов по типу (retail/wholesale) в админ-панели




